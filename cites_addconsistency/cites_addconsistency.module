<?php

class AddConsistency {

  private static $changes = array(
    "I/" => "i/",
    "COP" => "CoP",
    "ac-pc" => "AC-PC"
  );
  private static $correctExtensions = array(
    ".pdf", ".jpg", ".bmp", ".doc", ".docx", ".ppt", ".pptx", "gif", "bmp"
  );
  private static $possibleCorrectExtensions = array(
    ".html", ".shtml", ".php", ".html", ".phtml"
  );
  private $search = array("eng/esp/", "eng/fra/", "eng/eng/",
    "fra/esp/", "fra/fra/", "fra/eng/",
    "esp/esp/", "esp/fra/", "esp/eng/",
    "espsites/", "frasites/", "engsites/",
    "engeng/","engfra/","engesp/",
    "fraeng/","frafra/","fraesp/",
    "espeng/","espfra/","espesp/");
  private $replace = array("esp/", "fra/", "eng/",
    "esp/", "fra/", "eng/",
    "esp/", "fra/", "eng",
    "sites/", "sites/", "sites/",
    "eng/","fra/","esp/",
    "eng/","fra/","esp/",
    "eng/","fra/","esp/");

  public function __construct() {
    ;
  }

  public function changeNodeAliases() {
    // get all basic page nodes
    $result = db_query("SELECT *
      FROM `node`
      WHERE `type` = 'page'");
    foreach ($result as $record) {
      $nodeObj = node_load($record->nid);
      // check if the requested object exists
      if (!$nodeObj) {
        continue;
      }
      $alias = drupal_lookup_path("alias", "node/" . $nodeObj->nid);
      $firstPartAlias = substr($alias, 0, 4);
      $secondPartAlias = substr($alias, 4);
      if ($firstPartAlias == "eng/") {
        $espPath = drupal_lookup_path("source", "esp/" . $secondPartAlias);
        $fraPath = drupal_lookup_path("source", "fra/" . $secondPartAlias);
        $espObj = menu_get_object("node", 1, $espPath);
        $fraObj = menu_get_object("node", 1, $fraPath);
        if ($espObj != FALSE) {
          $nodeObj->title_field['es'][0]['value'] = $espObj->title;
          $nodeObj->title_field['es'][0]['format'] = 'full_html';
          $nodeObj->body['es'][0]['value'] = $espObj->body[$espObj->language][0]['value'];
          $nodeObj->body['es'][0]['format'] = 'unfiltered_html';
          node_delete($espObj->nid);
        }
        if ($fraObj != FALSE) {
          $nodeObj->title_field['fr'][0]['value'] = $fraObj->title;
          $nodeObj->title_field['fr'][0]['format'] = 'full_html';
          $nodeObj->body['fr'][0]['value'] = $fraObj->body[$fraObj->language][0]['value'];
          $nodeObj->body['fr'][0]['format'] = 'unfiltered_html';
          node_delete($fraObj->nid);
        }
        $nodeObj->title_field['en'][0]['value'] = $nodeObj->title;
        $nodeObj->title_field['en'][0]['format'] = 'full_html';
        $nodeObj->body['en'][0]['value'] = $nodeObj->body[$nodeObj->language][0]['value'];
        $nodeObj->body['en'][0]['format'] = 'unfiltered_html';
        $nodeObj->path['alias'] = $secondPartAlias;
        $nodeObj->translate = 1;
        node_save($nodeObj);
      }
      else if ($firstPartAlias == "fra/") {
        $engPath = drupal_lookup_path("source", "eng/" . $secondPartAlias);
        $espPath = drupal_lookup_path("source", "esp/" . $secondPartAlias);
        $espObj = menu_get_object("node", 1, $espPath);
        $engObj = menu_get_object("node", 1, $engPath);
        if ($espObj != FALSE) {
          $nodeObj->title_field['es'][0]['value'] = $espObj->title;
          $nodeObj->title_field['es'][0]['format'] = 'full_html';
          $nodeObj->body['es'][0]['value'] = $espObj->body[$espObj->language][0]['value'];
          $nodeObj->body['es'][0]['format'] = 'unfiltered_html';
          node_delete($espObj->nid);
        }
        if ($engObj != FALSE) {
          $nodeObj->title_field['en'][0]['value'] = $engObj->title;
          $nodeObj->title_field['en'][0]['format'] = 'full_html';
          $nodeObj->body['en'][0]['value'] = $engObj->body[$engObj->language][0]['value'];
          $nodeObj->body['en'][0]['format'] = 'unfiltered_html';
          node_delete($engObj->nid);
        }
        $nodeObj->title_field['fr'][0]['value'] = $nodeObj->title;
        $nodeObj->title_field['fr'][0]['format'] = 'full_html';
        $nodeObj->path['alias'] = $secondPartAlias;
        $nodeObj->body['fr'][0]['value'] = $nodeObj->body[$nodeObj->language][0]['value'];
        $nodeObj->body['fr'][0]['format'] = 'unfiltered_html';
        $nodeObj->translate = 1;
        node_save($nodeObj);
      }
      else if ($firstPartAlias == "esp/") {
        $engPath = drupal_lookup_path("source", "eng/" . $secondPartAlias);
        $fraPath = drupal_lookup_path("source", "fra/" . $secondPartAlias);
        $engObj = menu_get_object("node", 1, $engPath);
        $fraObj = menu_get_object("node", 1, $fraPath);
        if ($engObj != FALSE) {
          $nodeObj->title_field['en'][0]['value'] = $engObj->title;
          $nodeObj->title_field['en'][0]['format'] = 'full_html';
          $nodeObj->body['en'][0]['value'] = $engObj->body[$engObj->language][0]['value'];
          $nodeObj->body['en'][0]['format'] = 'unfiltered_html';
          node_delete($engObj->nid);
        }
        if ($fraObj != FALSE) {
          $nodeObj->title_field['fr'][0]['value'] = $fraObj->title;
          $nodeObj->title_field['fr'][0]['format'] = 'full_html';
          $nodeObj->body['fr'][0]['value'] = $fraObj->body[$fraObj->language][0]['value'];
          $nodeObj->body['fr'][0]['format'] = 'unfiltered_html';
          node_delete($fraObj->nid);
        }
        $nodeObj->title_field['es'][0]['value'] = $nodeObj->title;
        $nodeObj->title_field['es'][0]['format'] = 'full_html';
        $nodeObj->path['alias'] = $secondPartAlias;
        $nodeObj->body['es'][0]['value'] = $nodeObj->body[$nodeObj->language][0]['value'];
        $nodeObj->body['es'][0]['format'] = 'unfiltered_html';
        $nodeObj->translate = 1;
        node_save($nodeObj);
      }
    }
  }

  public function checkUrlsForNodes() {
    $pages = db_query("SELECT * FROM `node`
      WHERE `type` = 'page'");
    foreach ($pages as $page) {
      $nodeObj = node_load($page->nid);
      $content = $nodeObj->body[$nodeObj->language][0]['value'];
      $content = $this->changeUrlForTag($content, "img");
      $content = $this->changeUrlForTag($content, "a");
      $nodeObj->body[$nodeObj->language][0]['value'] = $content;
      node_save($nodeObj);
    }
  }

  private function changeUrlForTag($resource, $tag) {
    $dom = new DOMDocument();
    libxml_use_internal_errors(true);
    $dom->loadHTML($resource);
    libxml_use_internal_errors(false);
    $xpath = new DOMXPath($dom);
    $srcs = $xpath->evaluate("//$tag");
    
    for ($i = 0; $i < $srcs->length; $i++) {
      $src = $srcs->item($i);
      if ($tag == "a")
        $attribute = "href";
      else if ($tag == "img")
        $attribute = "src";
      else if ($tag == "embed")
        $attribute = "src";
      $url = $src->getAttribute($attribute);
      if ($this->isInFileExtensions($url, AddConsistency::$correctExtensions) && strpos($url, "sites/default/files")) {
        $url = $this->replaceLanguagePrefix($url);
        if (!file_exists($url)) {
          $newUrl = $this->changeUrl($url);
        }
        else {
          $newUrl = $url;
        }
      }
      else {
        $newUrl = $url;
      }
      if ($this->isInFileExtensions($url, AddConsistency::$possibleCorrectExtensions)) {
        $newUrl = $this->replaceLanguagePrefix($url);
      }
      else {
        $newUrl = $url;
      }
      $src->removeAttribute($attribute);
      $src->setAttribute($attribute, $newUrl);
    }
    $content = preg_replace(array("/^\<\!DOCTYPE.*?<html><body>/si",
      "!</body></html>$!si"), '', $dom->saveHTML());
    return $content;
  }

  private function isInFileExtensions($url, $fileExtensions) {
    foreach ($fileExtensions as $extension)
      if (strpos($url, $extension))
        return TRUE;
    return FALSE;
  }

  private function changeUrl($url) {
    foreach (AddConsistency::$changes as $before => $after) {
      if (file_exists(str_replace($before, $after, $url))) {
        return str_replace($before, $after, $url);
      }
    }
    return $url;
  }

  private function replaceLanguagePrefix($url) {
    return str_replace($this->search, $this->replace, $url);
  }

}
